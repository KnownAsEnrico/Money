<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Einkommen und Ausgaben Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f6f8;
            color: #333;
        }

        header {
            background-color: #4CAF50;
            padding: 20px;
            text-align: center;
            color: white;
        }

        h1 {
            margin: 0;
            font-size: 1.8em;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            margin: 20px;
            justify-content: center;
        }

        .list-container,
        .chart-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px;
            box-sizing: border-box;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 1 1 calc(50% - 40px);
            max-width: calc(50% - 40px);
            position: relative; /* Für die Tooltip-Positionierung */
        }

        .list-container h2,
        .chart-container h2 {
            margin-top: 0;
            color: #4CAF50;
            font-size: 1.5em;
        }

        .item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .item input[type="text"],
        .item input[type="number"] {
            padding: 10px;
            margin: 5px 5px 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1 1 100%;
            box-sizing: border-box;
        }

        .item input[type="number"] {
            max-width: 100%;
        }

        .item .remove-button {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            flex: 0 0 auto;
            margin: 5px 0;
        }

        .item .remove-button:hover {
            background-color: #e53935;
        }

        .add-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            font-size: 1em;
        }

        .add-button:hover {
            background-color: #43A047;
        }

        .sum-block {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 10px;
            flex: 1 1 100%;
            box-sizing: border-box;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }

        .sum-block p {
            margin: 10px 0;
            font-size: 1.2em;
        }

        .sum-block span {
            font-weight: 500;
            color: #4CAF50;
        }

        .chart {
            width: 100%;
            height: 300px;
            position: relative;
        }

        /* Tooltip-Stil */
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            font-size: 12px;
            z-index: 10;
            white-space: nowrap;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
            }

            .list-container,
            .chart-container {
                flex: 1 1 100%;
                max-width: 100%;
                margin: 10px 0;
            }

            .add-button {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 16px;
            }

            .item input[type="text"],
            .item input[type="number"],
            .add-button,
            .item .remove-button {
                font-size: 1em;
            }

            .sum-block p {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>

<header>
    <h1>Einkommen und Ausgaben Tracker</h1>
</header>

<div class="container">
    <div class="list-container" id="income-container">
        <h2>Einkommen</h2>
        <div id="income-list">
            <!-- Einkommens-Einheiten werden hier hinzugefügt -->
        </div>
        <button class="add-button" onclick="addItem('income')">Neue Einnahme hinzufügen</button>
    </div>

    <div class="list-container" id="expense-container">
        <h2>Ausgaben</h2>
        <div id="expense-list">
            <!-- Ausgaben-Einheiten werden hier hinzugefügt -->
        </div>
        <button class="add-button" onclick="addItem('expense')">Neue Ausgabe hinzufügen</button>
    </div>

    <!-- Bereich für die Diagramme -->
    <div class="chart-container">
        <h2>Einkommen - Diagramm</h2>
        <canvas id="incomeChart" class="chart"></canvas>
        <!-- Tooltip innerhalb des Chart-Containers -->
        <div class="tooltip" id="incomeTooltip"></div>
    </div>

    <div class="chart-container">
        <h2>Ausgaben - Diagramm</h2>
        <canvas id="expenseChart" class="chart"></canvas>
        <!-- Tooltip innerhalb des Chart-Containers -->
        <div class="tooltip" id="expenseTooltip"></div>
    </div>

    <div class="sum-block">
        <p>Netto-Einkommen: <span id="net-total">0.00</span> €</p>
        <p>Verbleibendes Einkommen: <span id="percentage">0.00</span>%</p>
    </div>
</div>

<script>
    // Variable zum Tracking des Ladezustands
    let isLoading = true;

    // Datenstruktur zum Speichern der Diagrammsegmente
    let chartData = {
        income: [],
        expense: []
    };

    function updateCharts() {
        drawPieChart('incomeChart', getDataWithNames('income'), 'income');
        drawPieChart('expenseChart', getDataWithNames('expense'), 'expense');
    }

    function getDataWithNames(type) {
        const items = document.querySelectorAll(`#${type}-list .item`);
        const data = [];
        items.forEach(item => {
            const name = item.querySelector('input[type="text"]').value.trim() || 'Unbenannt';
            const amount = parseFloat(item.querySelector('input[type="number"]').value) || 0;
            if (amount > 0) {
                data.push({ name, amount });
            }
        });
        return data;
    }

    function drawPieChart(canvasId, data, type) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');

        // Anpassung für hohe Auflösung
        const devicePixelRatio = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * devicePixelRatio;
        canvas.height = rect.height * devicePixelRatio;
        ctx.scale(devicePixelRatio, devicePixelRatio);

        const total = data.reduce((acc, val) => acc + val.amount, 0);

        // Farben für die Segmente
        const colors = generateColors(data.length);

        // Speicher der Segmente mit ihren Winkelbereichen und Prozentanteil
        const segments = [];

        // Zeichne den Hintergrund
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#f4f6f8';
        ctx.fillRect(0, 0, rect.width, rect.height);

        // Wenn keine Daten vorhanden sind
        if (data.length === 0 || total === 0) {
            ctx.font = '16px Arial';
            ctx.fillStyle = '#000';
            ctx.textAlign = 'center';
            ctx.fillText('Keine Daten verfügbar', rect.width / 2, rect.height / 2);
            chartData[type] = [];
            return;
        }

        // Mittelpunkt und Radius
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        const radius = Math.min(centerX, centerY) - 20;

        let startAngle = 0;

        data.forEach((item, index) => {
            const sliceAngle = (item.amount / total) * 2 * Math.PI;
            const percentage = ((item.amount / total) * 100).toFixed(1);

            // Zeichne das Segment
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle);
            ctx.closePath();
            ctx.fillStyle = colors[index];
            ctx.fill();

            // Speichere das Segment mit seinen Winkeln, Namen und Prozentanteil
            segments.push({
                startAngle: startAngle,
                endAngle: startAngle + sliceAngle,
                name: item.name,
                percentage: percentage
            });

            startAngle += sliceAngle;
        });

        // Speichere die Segmentdaten für die Interaktivität
        chartData[type] = segments;
    }

    // Funktion zur Generierung von Farben für die Segmente (ursprüngliche Farbpalette)
    function generateColors(numColors) {
        const colors = [];
        const baseColors = [
            '#4CAF50', // Grün
            '#FF9800', // Orange
            '#F44336', // Rot
            '#2196F3', // Blau
            '#9C27B0', // Lila
            '#00BCD4', // Türkis
            '#8BC34A', // Hellgrün
            '#FFC107', // Gelb
            '#E91E63', // Pink
            '#3F51B5', // Indigo
            '#FF5722', // Tieforange
            '#795548', // Braun
            '#607D8B', // Blaugrau
            '#673AB7', // Dunkelviolett
            '#009688'  // Teal
        ];

        for (let i = 0; i < numColors; i++) {
            colors.push(baseColors[i % baseColors.length]);
        }
        return colors;
    }

    // Event-Handling für Diagramm-Interaktivität
    function setupInteractivity() {
        // Funktion zur Bestimmung des Segments basierend auf der Position
        function getSegment(canvas, x, y, type) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const devicePixelRatio = window.devicePixelRatio || 1;

            // Korrigiere die Koordinaten basierend auf dem devicePixelRatio
            const mouseX = (x - rect.left) * scaleX / devicePixelRatio;
            const mouseY = (y - rect.top) * scaleY / devicePixelRatio;

            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            const radius = Math.min(centerX, centerY) - 20;

            const dx = mouseX - centerX;
            const dy = mouseY - centerY;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance > radius) {
                return null;
            }

            let angle = Math.atan2(dy, dx);
            if (angle < 0) angle += 2 * Math.PI;

            const segments = chartData[type];
            for (let segment of segments) {
                if (angle >= segment.startAngle && angle < segment.endAngle) {
                    return segment;
                }
            }
            return null;
        }

        // Funktion zur Anzeige des Tooltips
        function showTooltip(tooltipElement, text, percentage, x, y) {
            tooltipElement.style.left = x + 'px';
            tooltipElement.style.top = y + 'px';
            tooltipElement.innerText = `${text}: ${percentage}%`;
            tooltipElement.style.opacity = 1;
        }

        // Funktion zur Verbergung des Tooltips
        function hideTooltip(tooltipElement) {
            tooltipElement.style.opacity = 0;
        }

        // Füge Event-Listener zu beiden Diagrammen hinzu
        ['income', 'expense'].forEach(type => {
            const canvasId = `${type}Chart`;
            const canvas = document.getElementById(canvasId);
            const tooltipId = `${type}Tooltip`;
            const tooltip = document.getElementById(tooltipId);

            canvas.addEventListener('mousemove', function(event) {
                const nameAndPercentage = getSegment(canvas, event.clientX, event.clientY, type);
                if (nameAndPercentage) {
                    // Berechne die Position relativ zum Chart-Container
                    const rect = canvas.getBoundingClientRect();
                    const x = event.clientX - rect.left + 10;
                    const y = event.clientY - rect.top + 10;
                    showTooltip(tooltip, nameAndPercentage.name, nameAndPercentage.percentage, x, y);
                } else {
                    hideTooltip(tooltip);
                }
            });

            canvas.addEventListener('mouseout', function() {
                hideTooltip(tooltip);
            });

            // Touch-Events für mobile Geräte
            canvas.addEventListener('touchmove', function(event) {
                event.preventDefault(); // Verhindert Scrollen beim Tippen auf das Canvas
                const touch = event.touches[0];
                const nameAndPercentage = getSegment(canvas, touch.clientX, touch.clientY, type);
                if (nameAndPercentage) {
                    // Berechne die Position relativ zum Chart-Container
                    const rect = canvas.getBoundingClientRect();
                    const x = touch.clientX - rect.left + 10;
                    const y = touch.clientY - rect.top + 10;
                    showTooltip(tooltip, nameAndPercentage.name, nameAndPercentage.percentage, x, y);
                } else {
                    hideTooltip(tooltip);
                }
            });

            canvas.addEventListener('touchend', function() {
                hideTooltip(tooltip);
            });
        });
    }

    // Lädt die gespeicherten Daten beim Laden der Seite
    window.onload = function() {
        loadData('income');
        loadData('expense');
        calculateTotals();
        updateCharts();
        setupInteractivity();
        isLoading = false; // Laden abgeschlossen
    };

    // Diagramme bei Größenänderung des Fensters neu zeichnen
    window.onresize = function() {
        updateCharts();
    };

    function addItem(type, name = '', amount = 0) {
        const container = document.getElementById(`${type}-list`);

        const itemDiv = document.createElement('div');
        itemDiv.className = 'item';

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.placeholder = 'Name';
        nameInput.value = name;
        nameInput.oninput = () => {
            if (!isLoading) {
                saveData(type);
            }
            calculateTotals();
            updateCharts();
        };

        const amountInput = document.createElement('input');
        amountInput.type = 'number';
        amountInput.placeholder = 'Betrag';
        amountInput.value = amount;
        amountInput.oninput = () => {
            if (!isLoading) {
                saveData(type);
            }
            calculateTotals();
            updateCharts();
        };

        const removeButton = document.createElement('button');
        removeButton.className = 'remove-button';
        removeButton.innerText = 'Entfernen';
        removeButton.onclick = () => {
            container.removeChild(itemDiv);
            saveData(type);
            calculateTotals();
            updateCharts();
        };

        itemDiv.appendChild(nameInput);
        itemDiv.appendChild(amountInput);
        itemDiv.appendChild(removeButton);
        container.appendChild(itemDiv);

        calculateTotals();
        if (!isLoading) {
            saveData(type);
        }
        updateCharts();
    }

    function calculateTotals() {
        const incomeItems = document.querySelectorAll('#income-list .item');
        const expenseItems = document.querySelectorAll('#expense-list .item');

        let totalIncome = 0;
        incomeItems.forEach(item => {
            const amountInput = item.querySelector('input[type="number"]');
            totalIncome += parseFloat(amountInput.value) || 0;
        });

        let totalExpenses = 0;
        expenseItems.forEach(item => {
            const amountInput = item.querySelector('input[type="number"]');
            totalExpenses += parseFloat(amountInput.value) || 0;
        });

        const netTotal = totalIncome - totalExpenses;
        document.getElementById('net-total').innerText = netTotal.toFixed(2);

        const percentage = totalIncome ? (netTotal / totalIncome) * 100 : 0;
        document.getElementById('percentage').innerText = percentage.toFixed(2);
    }

    function saveData(type) {
        const items = [];
        const itemElements = document.querySelectorAll(`#${type}-list .item`);

        itemElements.forEach(item => {
            const nameInput = item.querySelector('input[type="text"]');
            const amountInput = item.querySelector('input[type="number"]');
            items.push({
                name: nameInput.value,
                amount: amountInput.value
            });
        });

        localStorage.setItem(`${type}Data`, JSON.stringify(items));
    }

    function loadData(type) {
        const data = localStorage.getItem(`${type}Data`);
        if (data) {
            isLoading = true; // Ladevorgang beginnt
            const items = JSON.parse(data);
            items.forEach(item => {
                addItem(type, item.name, item.amount);
            });
            isLoading = false; // Ladevorgang beendet
        } else {
            isLoading = false; // Kein Laden erforderlich
        }
    }
</script>
</body>
</html>
